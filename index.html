<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ì£¼ì‹ë¹„ì„œ (Pro)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Pretendard', sans-serif; background-color: #000; color: #fff; margin: 0; padding: 20px; line-height: 1.6; }
        h1 { text-align: center; color: #4dabf7; margin-bottom: 20px; }
        
        .tab-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; }
        .tab-btn { background: #333; border: 1px solid #555; color: #ccc; padding: 10px 20px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: #4dabf7; color: #000; font-weight: bold; }

        .card { background-color: #1c1c1e; border-radius: 18px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        .card-header { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; color: #868e96; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        /* ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ */
        .refresh-btn { font-size: 0.8em; color: #4dabf7; cursor: pointer; border: 1px solid #4dabf7; padding: 4px 10px; border-radius: 15px; }

        /* ìˆ˜ì • ê°€ëŠ¥í•œ ìì‚° ìŠ¤íƒ€ì¼ (ê°•ì¡°) */
        .editable { color: #ffd43b; text-decoration: underline; text-decoration-style: dotted; cursor: pointer; }
        .editable:hover { color: #fff; }
        
        .stock-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #2c2c2e; }
        .stock-price { font-weight: bold; color: #ff6b6b; }
        .total-asset { font-size: 2em; font-weight: bold; text-align: center; margin: 10px 0; }
        .update-time { text-align: center; font-size: 0.8em; color: #555; margin-bottom: 20px; }
        .status-msg { text-align: center; color: #888; font-size: 0.9em; padding: 20px; }

        /* ë‰´ìŠ¤ ìŠ¤íƒ€ì¼ */
        .news-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        .news-link { text-decoration: none; color: inherit; display: block; }
        .news-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; margin-bottom: 5px; background: #fa5252; color: white; }
        .news-title { font-size: 1em; font-weight: bold; margin-bottom: 5px; color: #e9ecef; }
        .ai-analysis { font-size: 0.8em; color: #888; }
    </style>
</head>
<body>

    <h1>ğŸ¤– ë‚˜ì˜ ì£¼ì‹ë¹„ì„œ</h1>

    <div class="tab-container">
        <button class="tab-btn active" onclick="openTab('dashboard')">ìì‚°í˜„í™©</button>
        <button class="tab-btn" onclick="openTab('news')">ìë™ ë‰´ìŠ¤</button>
    </div>

    <div id="dashboard" class="content">
        <div class="card">
            <div class="card-header">
                <span>ğŸ’° ì´ ìì‚° (Live)</span>
                <span class="refresh-btn" onclick="forceReload()">ğŸ”„ ì—…ë°ì´íŠ¸</span>
            </div>
            <div class="total-asset" id="totalMoney">ê³„ì‚° ì¤‘...</div>
            <div class="update-time" id="lastUpdated">ìµœê·¼ ê°±ì‹ : í™•ì¸ ì¤‘...</div>
            
            <div style="height: 200px; display: flex; justify-content: center;">
                <canvas id="assetChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>ğŸ  ê³ ì • ìì‚° (í„°ì¹˜í•´ì„œ ìˆ˜ì •)</span>
            </div>
            <div class="stock-item">
                <span>ë¶€ë™ì‚°(ìê°€)</span>
                <span class="stock-price editable" id="estateVal" onclick="editAsset('estate')">0ì›</span>
            </div>
            <div class="stock-item">
                <span>í˜„ê¸ˆ/ì ê¸ˆ</span>
                <span class="stock-price editable" id="cashVal" onclick="editAsset('cash')">0ì›</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>ğŸ“ˆ ì£¼ì‹/ì½”ì¸ (êµ¬ê¸€ì—°ë™)</span>
            </div>
            <div id="stockList">
                <div class="status-msg">ë°ì´í„° ì—°ê²° ì¤‘...</div>
            </div>
        </div>
    </div>

    <div id="news" class="content" style="display:none;">
        <div class="card">
            <div class="card-header">ğŸ“° ì‹¤ì‹œê°„ ì†ë³´</div>
            <div id="newsList">
                <div class="status-msg">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
        </div>
    </div>

    <script>
        // ì‚¬ì¥ë‹˜ì˜ CSV ì£¼ì†Œ (ë³€ê²½ ì—†ìŒ)
        const STOCK_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRRCRj74JyE0gUyQs4yWYXg__QxuOYpDiegz8W50mvORtk5x9I_KMYtZJOYwYOWpp6bZhPFBkQmmvc6/pub?gid=2144469712&single=true&output=csv";
        const NEWS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRRCRj74JyE0gUyQs4yWYXg__QxuOYpDiegz8W50mvORtk5x9I_KMYtZJOYwYOWpp6bZhPFBkQmmvc6/pub?gid=0&single=true&output=csv";
        
        // ì „ì—­ ë³€ìˆ˜ (ì£¼ì‹ í•©ê³„ ì €ì¥ìš©)
        let currentStockTotal = 0;

        // 1. ì €ì¥ëœ ìì‚° ë¶ˆëŸ¬ì˜¤ê¸° (ì‹œì‘í•˜ìë§ˆì ì‹¤í–‰)
        function loadSavedAssets() {
            // ì €ì¥ëœ ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 0ì›
            let estate = localStorage.getItem('myEstate') || "0";
            let cash = localStorage.getItem('myCash') || "0";
            
            // í™”ë©´ì— í‘œì‹œ
            document.getElementById('estateVal').innerText = Number(estate).toLocaleString() + "ì›";
            document.getElementById('cashVal').innerText = Number(cash).toLocaleString() + "ì›";
        }

        // 2. ìì‚° ìˆ˜ì •í•˜ê¸° (í„°ì¹˜ ì‹œ ì‹¤í–‰)
        function editAsset(type) {
            let currentVal = type === 'estate' ? localStorage.getItem('myEstate') : localStorage.getItem('myCash');
            // ì…ë ¥ì°½ ë„ìš°ê¸°
            let newVal = prompt("ìˆ˜ì •í•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ìˆ«ìë§Œ)", currentVal || "0");

            if (newVal !== null && !isNaN(newVal) && newVal.trim() !== "") {
                // ì €ì¥ (ë‚´ í°ì— ì €ì¥ë¨)
                if (type === 'estate') localStorage.setItem('myEstate', newVal);
                if (type === 'cash') localStorage.setItem('myCash', newVal);
                
                // í™”ë©´ ê°±ì‹ 
                loadSavedAssets();
                // ì´ ìì‚° ë‹¤ì‹œ ê³„ì‚°
                updateTotalDisplay();
            }
        }

        // 3. ì´ ìì‚° ê³„ì‚° ë° ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        function updateTotalDisplay() {
            let estate = Number(localStorage.getItem('myEstate') || 0);
            let cash = Number(localStorage.getItem('myCash') || 0);
            let fixedAssets = estate + cash;
            
            let grandTotal = currentStockTotal + fixedAssets;

            document.getElementById('totalMoney').innerText = "â‚© " + grandTotal.toLocaleString();
            
            // ì°¨íŠ¸ ê°±ì‹ 
            drawChart(currentStockTotal, fixedAssets);
        }

        // ==========================================
        // ì•„ë˜ëŠ” ê¸°ì¡´ ì£¼ì‹/ë‰´ìŠ¤ ë¡œë”© ë¡œì§ê³¼ ë™ì¼
        // ==========================================

        function forceReload() {
            document.getElementById('totalMoney').innerText = "ê°±ì‹  ì¤‘...";
            loadData(true);
        }

        async function loadData(force = false) {
            const timeStamp = force ? "&t=" + Date.now() : "";
            
            try {
                const res = await fetch(STOCK_URL + timeStamp);
                const text = await res.text();
                renderStocks(parseCSV(text));
                
                const now = new Date();
                document.getElementById('lastUpdated').innerText = "ìµœê·¼ ê°±ì‹ : " + now.toLocaleTimeString();
            } catch (e) {
                document.getElementById('stockList').innerHTML = '<div class="status-msg">âš ï¸ ì—°ê²° ì‹¤íŒ¨</div>';
            }

            try {
                const res = await fetch(NEWS_URL + timeStamp);
                const text = await res.text();
                renderNews(parseCSV(text));
            } catch (e) {}
        }

        function parseCSV(text) {
            return text.trim().split('\n').map(row => {
                const regex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)/g;
                let cells = [];
                let match;
                while (match = regex.exec(row)) {
                    cells.push(match[1].replace(/^"|"$/g, '').replace(/""/g, '"'));
                }
                return cells;
            });
        }

        function renderStocks(rows) {
            const list = document.getElementById('stockList');
            list.innerHTML = "";
            let totalVal = 0;
            
            rows.slice(1).forEach(row => {
                if(row.length < 3) return;
                const name = row[0];
                const price = parseFloat((row[2] || "0").replace(/,/g, '')); 
                const count = parseFloat((row[3] || "0").replace(/,/g, ''));
                
                if (name && price > 0) {
                    totalVal += price * count;
                    list.innerHTML += `
                        <div class="stock-item">
                            <span>${name} <small style="color:#888">(${count}ì£¼)</small></span>
                            <span class="stock-price">${price.toLocaleString()}ì›</span>
                        </div>`;
                }
            });

            // ì£¼ì‹ í•©ê³„ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            currentStockTotal = totalVal;
            // í™”ë©´ ê°±ì‹  í˜¸ì¶œ
            updateTotalDisplay();
        }

        function renderNews(rows) {
            const list = document.getElementById('newsList');
            list.innerHTML = "";
            rows.slice(0, 15).forEach(row => {
                let title = row[0]; let link = row[1];
                if (!title) return;
                if (title.length > 38) title = title.substring(0, 38) + "...";
                if (!link) link = "#";
                list.innerHTML += `
                    <div class="news-item">
                        <a href="${link}" target="_blank" class="news-link">
                            <span class="news-tag">LIVE</span>
                            <div class="news-title">${title}</div>
                            <div class="ai-analysis">ğŸ‘‰ í„°ì¹˜í•˜ì—¬ ê¸°ì‚¬ ë³´ê¸°</div>
                        </a>
                    </div>`;
            });
        }

        let myChart = null;
        function drawChart(stock, fixed) {
            const ctx = document.getElementById('assetChart');
            if(myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ì£¼ì‹/ì½”ì¸', 'ë¶€ë™ì‚°/í˜„ê¸ˆ'],
                    datasets: [{ data: [stock, fixed], backgroundColor: ['#ff6b6b', '#339af0'], borderWidth: 0 }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } }
            });
        }

        function openTab(id) {
            document.querySelectorAll('.content').forEach(e => e.style.display='none');
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).style.display='block';
            event.target.classList.add('active');
        }

        // ì•± ì¼œì§ˆ ë•Œ ì €ì¥ëœ ê°’ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸°
        loadSavedAssets();
        // ê·¸ ë‹¤ìŒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        loadData();

    </script>
</body>
</html>
